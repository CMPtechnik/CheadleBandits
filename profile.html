<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Player Profile</title>
  <link rel="icon" href="favicon.png" type="image/png" />
  <link rel="apple-touch-icon" href="favicon.png" sizes="180x180" />
  <meta name="theme-color" content="#ffffff" />
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <!-- Chart.js & XLSX -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root {
      --primary: #f4f4f4;
      --accent: #009688;
      --text: #333;
      --bg: #ffffff;
      --border: #ddd;
      --highlight: #4caf50;
    }
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text);
    }
    header {
      background: var(--accent);
      color: var(--bg);
      padding: 2rem 1rem;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    header nav a {
      color: var(--bg);
      text-decoration: none;
      margin: 0 0.5rem;
      font-size: 1rem;
    }
    #profileHeader {
      max-width: 800px;
      margin: 2rem auto;
      text-align: center;
      background: var(--primary);
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    #profileHeader .avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      border: 5px solid var(--highlight);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    #profileHeader h1 {
      margin: 1rem 0;
      font-size: 2rem;
      font-weight: 600;
    }
    #profileHeader ul {
      list-style: none;
      padding: 0;
      margin: 1rem 0;
      display: flex;
      justify-content: center;
      gap: 2rem;
    }
    #profileHeader ul li {
      font-weight: 600;
      color: var(--highlight);
    }
    #charts {
      max-width: 1000px;
      margin: 2rem auto;
      display: grid;
      gap: 2rem;
      grid-template-columns: 1fr 1fr;
      padding: 1rem;
    }
    .chart-container {
      background: var(--primary);
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      position: relative;
    }
    canvas {
      width: 100% !important;
      height: 300px !important;
    }
    #historySection {
      max-width: 1000px;
      margin: 2rem auto;
      background: var(--primary);
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    #historyTable {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    #historyTable th, #historyTable td {
      border: 1px solid var(--border);
      padding: 12px;
      text-align: center;
      font-weight: 500;
    }
    #historyTable th {
      background: var(--highlight);
      color: var(--bg);
    }
    .no-data {
      text-align: center;
      margin: 2rem auto;
      font-size: 1.2rem;
      color: var(--highlight);
    }
    @media screen and (max-width: 768px) {
      #charts {
        grid-template-columns: 1fr;
      }
      #profileHeader ul {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <header>
    <nav>
      <a href="index.html">Home</a> |
      <a href="profiles.html">All Players</a> |
      <a href="results.html">Results</a>
    </nav>
  </header>

  <div id="profileHeader"></div>

  <div id="charts" style="display:none;">
    <div class="chart-container">
      <canvas id="chartScore"></canvas>
    </div>
    <div class="chart-container">
      <canvas id="chartPosition"></canvas>
    </div>
    <div class="chart-container">
      <canvas id="chartSF"></canvas>
    </div>
  </div>

  <section id="historySection" style="display:none;">
    <h2>Competition History</h2>
    <table id="historyTable">
      <thead>
        <tr><th>Date</th><th>Competition</th><th>Score</th><th>Stableford</th><th>Points</th><th>Winnings</th><th>Trophy</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <div id="noData" class="no-data" style="display:none;">No data found for this player.</div>

  <script>
    function parseDateStr(s) {
      if (typeof s === 'string' && s.includes('/')) {
        const [d, m, y] = s.split('/');
        return new Date(y, m - 1, d);
      }
      return new Date(s);
    }

    const params = new URLSearchParams(window.location.search);
    const playerName = decodeURIComponent(params.get('name') || '');

    fetch('https://raw.githubusercontent.com/cmptechnik/CheadleBandits/main/data/leaguedata.xlsx?v=' + Date.now())
      .then(res => res.arrayBuffer())
      .then(buffer => {
        const wb = XLSX.read(buffer, { type:'array' });
        const sheet = wb.Sheets[wb.SheetNames[0]];
        const history = XLSX.utils.sheet_to_json(sheet);

        const recs = history.filter(r => r.Name && r.Name.toLowerCase() === playerName.toLowerCase());

        if (!recs.length) {
          document.getElementById('noData').style.display = 'block';
          return;
        }

        document.getElementById('charts').style.display = '';
        document.getElementById('historySection').style.display = '';

        // Compute stats
        const games = recs.length;
        const totalPoints = recs.reduce((sum, r) => sum + (parseFloat(r.Points) || 0), 0);
        const totalWinnings = recs.reduce((sum, r) => sum + (parseFloat(r.Winnings) || 0), 0);
        const trophies = recs.filter(r => parseInt(r.Position) === 1).length;
        const winPct = games ? ((trophies / games) * 100).toFixed(1) : 0;

        // Render header without AvatarURL
        document.getElementById('profileHeader').innerHTML = `
          <img class="avatar" src="default.png" alt="${playerName}" />
          <h1>${playerName}</h1>
          <ul class="stats">
            <li>Games: ${games}</li>
            <li>Total Points: ${totalPoints}</li>
            <li>Win %: ${winPct}%</li>
            <li>Trophies: ${trophies}</li>
            <li>Winnings: ¬£${totalWinnings.toFixed(2)}</li>
          </ul>
        `;

        const competitions = recs.map(r => r.Title || r.Competition);
        const dates = recs.map(r => parseDateStr(r.Date).toLocaleDateString());
        const scores = recs.map(r => parseFloat(r.Score) || 0);
        const positions = recs.map(r => parseInt(r.Position) || 0);
        const sfs = recs.map(r => parseInt(r['Stableford Points']) || 0);

        // Filter out Stableford competitions for Net Score chart (Stroke Play only)
        const netScores = scores.filter((score, index) => sfs[index] === 0);  // Exclude Stableford competitions
        const stablefordScores = sfs.filter(sf => sf > 0);  // Only include Stableford points
        const stablefordCompetitions = competitions.filter((competition, index) => sfs[index] > 0);  // Only Stableford competitions

        // Net Score Chart (only Stroke Play)
        const ctxScore = document.getElementById('chartScore').getContext('2d');
        new Chart(ctxScore, {
          type: 'line',
          data: {
            labels: competitions,
            datasets: [
              { label: 'Net Score', data: netScores, fill: false, borderColor: '#4caf50', borderWidth: 3, tension: 0.2 },
              { label: 'Par 64', data: new Array(competitions.length).fill(64), borderDash: [5,5], fill: false, borderColor: '#ff7043', borderWidth: 2 }
            ]
          },
          options: {
            responsive: true,
            animation: { duration: 1000 },
            scales: { x: { grid: { display: false } }, y: { min: 50, max: 100 } }
          }
        });

        // Position Chart
        const ctxPos = document.getElementById('chartPosition').getContext('2d');
        new Chart(ctxPos, {
          type: 'line',
          data: {
            labels: competitions,
            datasets: [{ label: 'Position', data: positions, fill: false, borderColor: '#0288d1', borderWidth: 3 }]
          },
          options: {
            responsive: true,
            animation: { duration: 1000 },
            scales: { y: { reverse: true } }
          }
        });

        // Stableford Chart (only Stableford competitions)
        const ctxSF = document.getElementById('chartSF').getContext('2d');
        new Chart(ctxSF, {
          type: 'bar',
          data: {
            labels: stablefordCompetitions,
            datasets: [{ label: 'Stableford Points', data: stablefordScores, backgroundColor: '#81c784' }]
          },
          options: {
            responsive: true,
            animation: { duration: 1000 },
            scales: { y: { beginAtZero: true } }
          }
        });

        const tbody = document.querySelector('#historyTable tbody');
        recs.sort((a,b) => parseDateStr(b.Date) - parseDateStr(a.Date)).forEach(r => {
          const trophy = parseInt(r.Position) === 1 ? 'üèÜ' : '';
          const win = isNaN(parseFloat(r.Winnings)) ? 0 : parseFloat(r.Winnings);
          const sf = isNaN(parseInt(r['Stableford Points'])) ? 0 : parseInt(r['Stableford Points']);
          tbody.innerHTML += `
            <tr>
              <td>${parseDateStr(r.Date).toLocaleDateString()}</td>
              <td>${r.Title||r.Competition}</td>
              <td>${r.Score||''}</td>
              <td>${sf}</td>
              <td>${r.Points||''}</td>
              <td>¬£${win.toFixed(2)}</td>
              <td>${trophy}</td>
            </tr>
          `;
        });
      })
      .catch(err => console.error('Error loading profile data:', err));
  </script>
</body>
</html>
